#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

cd "$(dirname -- "$0")/.." || exit 1

echo "üöÄ Running pre-push checks in parallel..."
echo ""

# Run client checks in background
(
  echo "=== Running client checks ==="
  cd client || exit 1
  npx concurrently --raw --kill-others-on-fail \
    "npm run lint" \
    "npm run format" \
    "npm run typecheck" \
    "npm run build"
  CLIENT_EXIT=$?
  if [ $CLIENT_EXIT -eq 0 ]; then
    echo "‚úÖ Client checks passed"
  else
    echo "‚ùå Client checks failed"
  fi
  exit $CLIENT_EXIT
) &
CLIENT_PID=$!

# Run server checks in background
(
  echo "=== Running server checks ==="
  cd server || exit 1
  npx concurrently --raw --kill-others-on-fail \
    "npm run lint" \
    "npm run format" \
    "npm run test" \
    "npm run build"
  SERVER_EXIT=$?
  if [ $SERVER_EXIT -eq 0 ]; then
    echo "‚úÖ Server checks passed"
  else
    echo "‚ùå Server checks failed"
  fi
  exit $SERVER_EXIT
) &
SERVER_PID=$!

# Wait for both to complete
wait $CLIENT_PID
CLIENT_EXIT=$?

wait $SERVER_PID
SERVER_EXIT=$?

echo ""

# Exit with error if either failed
if [ $CLIENT_EXIT -ne 0 ] || [ $SERVER_EXIT -ne 0 ]; then
  echo "‚ùå Pre-push checks failed"
  exit 1
fi

echo "‚úÖ All pre-push checks passed"

